- suppliers = order.line_items.includes(variant: :supplier).map(&:supplier).uniq
- rateable_enterprises = suppliers
- if order.distributor.present? && !rateable_enterprises.include?(order.distributor)
  - rateable_enterprises << order.distributor
- ratings_by_enterprise = order.enterprise_ratings.where(user: spree_current_user).index_by(&:enterprise_id)

.order-seller-ratings
  %h3= t("ratings.section_title")

  - if rateable_enterprises.empty?
    %p= t("ratings.no_suppliers")
  - else
    - rateable_enterprises.each do |enterprise|
      - rating = ratings_by_enterprise[enterprise.id] || order.enterprise_ratings.build(enterprise: enterprise, user: spree_current_user)
      .order-seller-rating
        %h4= enterprise.name
        = form_with model: rating,
                    url: rating.persisted? ? main_app.order_enterprise_rating_path(order, rating) : main_app.order_enterprise_ratings_path(order),
                    method: rating.persisted? ? :patch : :post,
                    local: true do |form|
          = form.hidden_field :enterprise_id, value: enterprise.id
          .row
            .columns.large-4
              = form.label :rating, t("ratings.rating_label")
              = form.select :rating,
                            options_for_select((1..5).to_a, rating.rating),
                            { include_blank: true },
                            class: "select"
            .columns.large-8
              = form.label :comment, t("ratings.comment_label")
              = form.text_area :comment, rows: 3
          .row
            .columns.large-12
              = form.submit rating.persisted? ? t("ratings.update") : t("ratings.submit"), class: "button primary"
